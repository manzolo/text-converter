name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  integration-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env file
      run: |
        cp .env.example .env
        echo "USE_EXTERNAL_OLLAMA=false" >> .env
        echo "OLLAMA_HOST=http://ollama:11434" >> .env
        echo "OLLAMA_MODEL=llama3.1:8b" >> .env

    - name: Start services with docker-compose
      run: |
        docker-compose -f docker-compose.yml up -d
        echo "Waiting for services to be ready..."
        sleep 30

    - name: Wait for API to be ready
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done'
        echo "API is ready!"

    - name: Pull Ollama model
      run: |
        docker exec ollama-cpu ollama pull llama3.1:8b
      timeout-minutes: 10
      continue-on-error: true

    - name: Run integration tests
      run: |
        chmod +x test.sh
        ./test.sh

    - name: Upload test outputs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-outputs
        path: test_output/

    - name: Show logs on failure
      if: failure()
      run: |
        echo "=== Application Logs ==="
        docker logs text-converter-cpu
        echo ""
        echo "=== Ollama Logs ==="
        docker logs ollama-cpu

    - name: Cleanup
      if: always()
      run: |
        docker-compose -f docker-compose.yml down -v

  docker-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker-compose -f docker-compose.yml build

    - name: Test Docker build
      run: |
        docker images | grep text-converter

  integration-test:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env file
      run: |
        cp .env.example .env
        echo "USE_EXTERNAL_OLLAMA=false" >> .env

    - name: Start services
      run: |
        docker-compose -f docker-compose.yml up -d
        sleep 30

    - name: Wait for services to be ready
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done'

    - name: Pull Ollama model in container
      run: |
        docker exec ollama-cpu ollama pull llama3.1:8b
      timeout-minutes: 10
      continue-on-error: true

    - name: Run integration tests
      run: |
        # Test health endpoint
        curl -f http://localhost:8000/health

        # Test API docs
        curl -f http://localhost:8000/docs

        # Test file conversion (without AI to speed up)
        echo "Test content" > test.txt
        curl -X POST http://localhost:8000/convert \
          -F "file=@test.txt" \
          -F "output_format=markdown" \
          -F "use_ai=false" \
          -o output.md

        # Verify output file was created
        test -f output.md

    - name: Show logs on failure
      if: failure()
      run: |
        docker-compose -f docker-compose.yml logs

    - name: Cleanup
      if: always()
      run: |
        docker-compose -f docker-compose.yml down -v
